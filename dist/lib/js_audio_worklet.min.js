/******/ (function(modules) { // webpackBootstrap
/******/ 	// The module cache
/******/ 	var installedModules = {};
/******/
/******/ 	// The require function
/******/ 	function __webpack_require__(moduleId) {
/******/
/******/ 		// Check if module is in cache
/******/ 		if(installedModules[moduleId]) {
/******/ 			return installedModules[moduleId].exports;
/******/ 		}
/******/ 		// Create a new module (and put it into the cache)
/******/ 		var module = installedModules[moduleId] = {
/******/ 			i: moduleId,
/******/ 			l: false,
/******/ 			exports: {}
/******/ 		};
/******/
/******/ 		// Execute the module function
/******/ 		modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);
/******/
/******/ 		// Flag the module as loaded
/******/ 		module.l = true;
/******/
/******/ 		// Return the exports of the module
/******/ 		return module.exports;
/******/ 	}
/******/
/******/
/******/ 	// expose the modules object (__webpack_modules__)
/******/ 	__webpack_require__.m = modules;
/******/
/******/ 	// expose the module cache
/******/ 	__webpack_require__.c = installedModules;
/******/
/******/ 	// define getter function for harmony exports
/******/ 	__webpack_require__.d = function(exports, name, getter) {
/******/ 		if(!__webpack_require__.o(exports, name)) {
/******/ 			Object.defineProperty(exports, name, { enumerable: true, get: getter });
/******/ 		}
/******/ 	};
/******/
/******/ 	// define __esModule on exports
/******/ 	__webpack_require__.r = function(exports) {
/******/ 		if(typeof Symbol !== 'undefined' && Symbol.toStringTag) {
/******/ 			Object.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });
/******/ 		}
/******/ 		Object.defineProperty(exports, '__esModule', { value: true });
/******/ 	};
/******/
/******/ 	// create a fake namespace object
/******/ 	// mode & 1: value is a module id, require it
/******/ 	// mode & 2: merge all properties of value into the ns
/******/ 	// mode & 4: return value when already ns object
/******/ 	// mode & 8|1: behave like require
/******/ 	__webpack_require__.t = function(value, mode) {
/******/ 		if(mode & 1) value = __webpack_require__(value);
/******/ 		if(mode & 8) return value;
/******/ 		if((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;
/******/ 		var ns = Object.create(null);
/******/ 		__webpack_require__.r(ns);
/******/ 		Object.defineProperty(ns, 'default', { enumerable: true, value: value });
/******/ 		if(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));
/******/ 		return ns;
/******/ 	};
/******/
/******/ 	// getDefaultExport function for compatibility with non-harmony modules
/******/ 	__webpack_require__.n = function(module) {
/******/ 		var getter = module && module.__esModule ?
/******/ 			function getDefault() { return module['default']; } :
/******/ 			function getModuleExports() { return module; };
/******/ 		__webpack_require__.d(getter, 'a', getter);
/******/ 		return getter;
/******/ 	};
/******/
/******/ 	// Object.prototype.hasOwnProperty.call
/******/ 	__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };
/******/
/******/ 	// __webpack_public_path__
/******/ 	__webpack_require__.p = "";
/******/
/******/
/******/ 	// Load entry module and return exports
/******/ 	return __webpack_require__(__webpack_require__.s = "./src/worklet/js_audio_worklet.js");
/******/ })
/************************************************************************/
/******/ ({

/***/ "./src/worklet/js_audio_worklet.js":
/*!*****************************************!*\
  !*** ./src/worklet/js_audio_worklet.js ***!
  \*****************************************/
/*! no static exports found */
/***/ (function(module, exports) {

/*
author: Hf.Platform.Seth.Wang
Date: July,2017

*/
function Queue() {
    this.a = [];
    this.b = 0;
    this.residue = null;
    //  this.key = key;
};
Queue.prototype.getLength = function() {
    return this.a.length - this.b
};
Queue.prototype.isEmpty = function() {
    return 0 == this.a.length
};
Queue.prototype.enqueue = function(data) {
    this.a.push(data)
};
Queue.prototype.dequeue = function() {
    if (0 != this.a.length) {
        var c = this.a[this.b];
        2 * ++this.b >= this.a.length && (this.a = this.a.slice(this.b), this.b = 0);
        return c
    }
    return null;
};
Queue.prototype.peek = function() {
    return 0 < this.a.length ? this.a[this.b] : void 0
}

function AudioQueueMGR() {

    this.ssrcQueueMap = new Map();
    AudioQueueMGR.prototype.AddQueue = function(key) {
        var queue = new Queue();
        this.ssrcQueueMap.set(key, queue);
        return queue;
    }
    AudioQueueMGR.prototype.DeleteQueue = function(key) {
        this.ssrcQueueMap.delete(key);
    }
    AudioQueueMGR.prototype.GetQueue = function(key) {
        var queue_ = this.ssrcQueueMap.get(key);
        return queue_;
    }
    AudioQueueMGR.prototype.GetQueueData = function(key) {
        var queue_ = this.ssrcQueueMap.get(key);
        return queue_.dequeue();
    }
    AudioQueueMGR.prototype.PutQueueData = function(key, data) {
        var queue_ = this.ssrcQueueMap.get(key);
        queue_.enqueue(data)
    }
    AudioQueueMGR.prototype.GetQueueLength = function(key) {
        var queue_ = this.ssrcQueueMap.get(key);
        if (queue_ !== null) {
            return queue_.getLength();
        }
        return 0;
    }

};

var AudioMGR = (function() {
    function AudioMGR() {
        this.map = new Map();
        this.AudioQueueMGR = new AudioQueueMGR();
        this.timemap = new Map();
    };
    AudioMGR.prototype.Add = function(ssrc, audio_webwork) {
        this.map.put(ssrc, audio_webwork);
        this.AudioQueueMGR.AddQueue(ssrc);
    }
    AudioMGR.prototype.Clear = function() {
        this.map.clear();
    }
    AudioMGR.prototype.Keys = function() {
        return this.map.keys();
    }
    AudioMGR.prototype.UpdateSSRCTimeMap = function(timestamp) {
        this.timemap = timestamp;
    }
    AudioMGR.prototype.GetSSRCTimeMap = function(ssrc) {
        if (this.timemap) {
            return this.timemap.get(ssrc);
        }
        return null;

    }
    return AudioMGR;
})();

function Get_Decoded_Audio_Buffer_Length(ssrc) {
    ssrc = 0;
    if (localAudioDecMGR) {
        return localAudioDecMGR.AudioQueueMGR.GetQueueLength(ssrc);
    }
    return 0;
}
// var Audio_Buffer = new Queue();
// var residue = null;
var start_play = false;
var localAudioDecMGR = new AudioMGR();
var audioBufferSize = 10;
var start_capture = false;
var current_ssrc = null;
var audio_count = 0;
var AUDIO_UPDATE_SSRC_TIME_INTERVAL = 23;
var LOG_PRINT_INTERVAL = 10000;
var log_count = 0;
var post_capture_audio_count = 0;
var AUDIO_CAPTURE_MAX_COUNT = 0;
var capture_audio_buffer = null;
var audioEncodePort;
var audioDecodePort;
var audioDecodePortWithVideo = null;
var ssrcNtpMap = new Map();
var residueOffset = 0;
function Put_Audio_Frame_Buffer(ssrc, buffer, time_stamp, that) {
    ssrc = 0;
    if (!start_play) {
        return;
    }
    if (localAudioDecMGR) {
        var ssrcqueue_ = localAudioDecMGR.AudioQueueMGR.GetQueue(ssrc); // need special ssrc, as audio had been Mixed.
        if (!ssrcqueue_) {
            ssrcqueue_ = localAudioDecMGR.AudioQueueMGR.AddQueue(ssrc);
        }
        // buffer = Uint8ToFloat32(buffer);
        if (time_stamp) {
            // var timemap = new Map();
            var numberOfSSRC = time_stamp.length / 12;
            var index = 0;
            var i = 0;
            for (index = 0; index < numberOfSSRC; index++) {
                var ssrc = 0;
                for (i = index * 12 + 0; i < index * 12 + 4; i++) {
                    ssrc += time_stamp[i] * Math.pow(256, (i - index * 12));
                }
                ssrc = ssrc >> 10;
                var ts = 0;
                for (i = index * 12 + 4; i < index * 12 + 12; i++) {
                    ts += time_stamp[i] * Math.pow(256, (i - index * 12 - 4));
                }
                ssrcNtpMap.set(ssrc, ts);
            }
            var message = buffer;
            Send_Buffer_Back_TO_Decode_Worker(time_stamp)
        } else {
            var message = buffer;
        }

        ssrcqueue_.enqueue(message);
        var audioqueuelength = Get_Decoded_Audio_Buffer_Length(ssrc);
        // console.log("audio queue length: "+audioqueuelength)
        if (audioqueuelength > 7) {
            if (audioDecodePort)
                audioDecodePort.postMessage({
                    status: "delay",
                });
        } else if (audioqueuelength > 50) {
            var diff = audioqueuelength - audioBufferSize;
            while (diff >= 0) {
                Delete_Decoded_Audio_Frame(ssrc);
                diff--;
            }
        }
    }
}

function Delete_Decoded_Audio_Frame(ssrc) {
    ssrc = 0;
    if (!localAudioDecMGR) {
        return;
    }
    var ssrc_queue_ = localAudioDecMGR.AudioQueueMGR.GetQueue(ssrc)
    if (ssrc_queue_) {
        var data_node = ssrc_queue_.dequeue();
        Send_Buffer_Back_TO_Decode_Worker(data_node);
        return data_node;
    }
    return null;
}

function Get_SSRC_Latest_Time(e) {
    e = e >> 10;
    if (localAudioDecMGR) {
        var t = ssrcNtpMap.get(e);
        if (!t) {
            return 0;
        } else {
            ssrcNtpMap.set(e, 0);
            return t;
        }
    }
}

function Send_Buffer_Back_TO_Decode_Worker(buff) {
    if (audioDecodePort) {
        var data = {
            status: "trash",
            data: buff
        };
        audioDecodePort.postMessage(data, [data.data.buffer]);
    }
}
function Get_Decoded_Audio_Frame(ssrc, time_stamp, Audio_Node_Buffer_Size, output) {
    if (!localAudioDecMGR) {
        return;
    }
    ssrc = 0;
    var ssrc_queue = localAudioDecMGR.AudioQueueMGR.GetQueue(ssrc);
    var audio_data = null;
    if (ssrc_queue) {
        if (ssrc_queue.residue) {
            let realLeft = ssrc_queue.residue.length - residueOffset;
            if (realLeft > Audio_Node_Buffer_Size) {
                // let local_residue_length = ssrc_queue.residue.buffer.length;
                // audio_data = ssrc_queue.residue.buffer.slice(0, Audio_Node_Buffer_Size);
                // ssrc_queue.residue.buffer = ssrc_queue.residue.buffer.slice(Audio_Node_Buffer_Size)
                output.set(ssrc_queue.residue.subarray(residueOffset, (residueOffset + Audio_Node_Buffer_Size)), (output.length - Audio_Node_Buffer_Size));
                residueOffset = residueOffset + Audio_Node_Buffer_Size;
                // Update_Audio_SSRC_Time(ssrc_queue.residue.ntptime);
                return ;
            } else if (realLeft === Audio_Node_Buffer_Size) {
                // audio_data = ssrc_queue.residue.buffer;
                // Update_Audio_SSRC_Time(ssrc_queue.residue.ntptime);
                output.set(ssrc_queue.residue.subarray(residueOffset, (residueOffset + Audio_Node_Buffer_Size)), (output.length - Audio_Node_Buffer_Size));
                Send_Buffer_Back_TO_Decode_Worker(ssrc_queue.residue);
                ssrc_queue.residue = null;
                residueOffset = 0;

                return ;
            } else {
                audio_data = ssrc_queue.residue;
                // Update_Audio_SSRC_Time(ssrc_queue.residue.ntptime);
                output.set(ssrc_queue.residue.subarray(residueOffset, audio_data.length), (output.length - Audio_Node_Buffer_Size));
                // oneAudioFrame.set(ssrc_queue.residue.buffer, residueOffset, audio_data.length);
                Send_Buffer_Back_TO_Decode_Worker(ssrc_queue.residue);
                ssrc_queue.residue = null;
                residueOffset = 0;
                Audio_Node_Buffer_Size = Audio_Node_Buffer_Size - realLeft;
            }
        }

        var data_node = ssrc_queue.dequeue();
        while (data_node && data_node.length < Audio_Node_Buffer_Size) {
            // Update_Audio_SSRC_Time(data_node.ntptime);
            // audio_data = Float32Concat(audio_data, data_node.buffer);
            output.set(data_node, output.length - Audio_Node_Buffer_Size);
            Send_Buffer_Back_TO_Decode_Worker(data_node);
            Audio_Node_Buffer_Size = Audio_Node_Buffer_Size - data_node.length
            data_node = ssrc_queue.dequeue();
        }

        if (data_node) {
            // Update_Audio_SSRC_Time(data_node.ntptime);
            if (data_node.length === Audio_Node_Buffer_Size) {
                // audio_data = Float32Concat(audio_data, data_node.buffer);
                output.set(data_node, output.length - Audio_Node_Buffer_Size);
                residueOffset = 0;
                Send_Buffer_Back_TO_Decode_Worker(data_node);
                return;
            } else if (data_node.length > Audio_Node_Buffer_Size) {
                // audio_data = Float32Concat(audio_data, data_node.buffer.slice(0, Audio_Node_Buffer_Size));
                output.set(data_node.subarray(0,Audio_Node_Buffer_Size), output.length - Audio_Node_Buffer_Size)
                ssrc_queue.residue = data_node;
                residueOffset = Audio_Node_Buffer_Size;
                return;
            }
        } else {
            // console.log("queue is empty")
        }
        // if (audio_data) {
        //     if (audio_data.length < audio_length) {
        //         ssrc_queue.residue = {
        //             buffer: audio_data,
        //             ntptime: null
        //         }
        //         return null;
        //     } else if (audio_data.length == audio_length) {
        //         return audio_data;
        //     }
        // }
    }
    return;
}

class ZoomAudioWorletProcessor extends AudioWorkletProcessor {

    // Custom AudioParams can be defined with this static getter.
    static get parameterDescriptors() {
        return [{ name: 'pcm', defaultValue: 1 }];
    }

    constructor() {
        // The super constructor call is required.
        super();
        this.port.onmessage = this.handleMessage.bind(this);
        this.sampleRate_ = 0;
        this.tenMilliSecondsLength_ = 0;
    }

    handleMessage(event) {
        // console.log('[Processor:Received] "' + event.data.message +
        //     '" (' + event.data.timeStamp + ')');
        var data = event.data;
        switch (data.status) {
            case "data":
            {
                if (start_play) {
                    // Audio_Buffer.enqueue(Uint8ToFloat32(data.data));
                    Put_Audio_Frame_Buffer(data.data.ssrc, data.data.data, data.data.time, this);
                    current_ssrc = data.data.ssrc;
                    // if(!current_ssrc){
                    //     current_ssrc = data.data.ssrc;
                    // }
                }
            }
                break;
            case "stopPlayAudio":
            {
                start_play = false;
            }
                break;
            case "startPlayAudio":
            {
                start_play = true;
            }
                break;
            case "close":
            {
                // close();
            }
                break;
            case "StartCaptureAudio":
            {
                start_capture = true;
                post_capture_audio_count = 0;
            }
                break;
            case "CurrentSSRC":
            {
                current_ssrc = data.data;
            }
                break;
            case "encodeAudioPort":
            {
                if(audioEncodePort){
                    audioEncodePort.close();
                }
                audioEncodePort = event.ports[0];
            }
                break;
            case "decodeAudioPort": {
                var that = this;
                if (audioDecodePort) {
                    audioDecodePort.close();
                }
                audioDecodePort = event.ports[0];
                audioDecodePort.onmessage = function (e) {
                    if (start_play) {
                        // Audio_Buffer.enqueue(Uint8ToFloat32(data.data));
                        Put_Audio_Frame_Buffer(e.data.ssrc, e.data.data, e.data.time, that);
                        current_ssrc = e.data.ssrc;
                    }
                    if (start_capture&&false) {
                        var data = {
                            command: "EchoCancel",
                            data: e.data.aec,
                            channels: e.data.channels,
                            sampleHz: e.data.sampleHz
                        };
                        audioEncodePort.postMessage(data, [data.data.buffer]);
                    }
                }
            }
                break;
            case "decodeAudioPortWithVideo": {
                audioDecodePortWithVideo = event.ports[0];
            }
                break;
            case "sampleRate": {
                this.sampleRate_ = data.data;
                //this.sampleRate /100 == 10ms
                //8000hz is base line for audio app.
                if (this.sampleRate_ >= 8000) {
                    this.tenMilliSecondsLength_ = this.sampleRate_ / 100;
                    //the maximum buffer delay set to be 30ms.
                    AUDIO_CAPTURE_MAX_COUNT = Math.ceil(((this.tenMilliSecondsLength_) * 3) / 128);
                    capture_audio_buffer = new Float32Array(128 * AUDIO_CAPTURE_MAX_COUNT);
                }
            }
                break;
        }
    }

    process(inputs, outputs, parameters) {
        let input = inputs[0];
        let output = outputs[0];

        if (!this.sampleRate_ || !output[0]) {
          return true;
        }
        Get_Decoded_Audio_Frame(0, 0, output[0].length, output[0])

        if (input[0] && start_capture) {
            capture_audio_buffer.set(input[0],post_capture_audio_count * 128);
            post_capture_audio_count++;
            if(post_capture_audio_count == AUDIO_CAPTURE_MAX_COUNT){
                post_capture_audio_count = 0;
                audioEncodePort.postMessage({
                    command:"EncodeAudioFrame",
                    data:capture_audio_buffer
                })
            }
        }

        if(current_ssrc){
            audio_count++;
            if (audio_count == AUDIO_UPDATE_SSRC_TIME_INTERVAL) {
                audio_count = 0;
                var time = Get_SSRC_Latest_Time(current_ssrc);
                if(time){
                    if(audioDecodePortWithVideo){
                        audioDecodePortWithVideo.postMessage({
                            data: time
                        })
                    }else{
                        this.port.postMessage({
                            status: "InstantAudioTime",
                            data: time
                        });
                    }
                }
            }
        }

        for (let channel = 1; channel < output.length; ++channel) {
            let outputChannel = output[channel];
            outputChannel.set(output[0]);
        }

        return true;
    }
}

registerProcessor('zoomAudioWorklet', ZoomAudioWorletProcessor);


/***/ })

/******/ });
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly8vd2VicGFjay9ib290c3RyYXAiLCJ3ZWJwYWNrOi8vLy4vc3JjL3dvcmtsZXQvanNfYXVkaW9fd29ya2xldC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7QUFDQTs7QUFFQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7OztBQUdBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQSxrREFBMEMsZ0NBQWdDO0FBQzFFO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0EsZ0VBQXdELGtCQUFrQjtBQUMxRTtBQUNBLHlEQUFpRCxjQUFjO0FBQy9EOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpREFBeUMsaUNBQWlDO0FBQzFFLHdIQUFnSCxtQkFBbUIsRUFBRTtBQUNySTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBLG1DQUEyQiwwQkFBMEIsRUFBRTtBQUN2RCx5Q0FBaUMsZUFBZTtBQUNoRDtBQUNBO0FBQ0E7O0FBRUE7QUFDQSw4REFBc0QsK0RBQStEOztBQUVySDtBQUNBOzs7QUFHQTtBQUNBOzs7Ozs7Ozs7Ozs7QUNsRkE7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBLENBQUM7O0FBRUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHVFQUF1RTtBQUN2RTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwyQkFBMkIsc0JBQXNCO0FBQ2pEO0FBQ0Esd0NBQXdDLG9CQUFvQjtBQUM1RDtBQUNBO0FBQ0E7QUFDQTtBQUNBLHdDQUF3QyxxQkFBcUI7QUFDN0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakIsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZ0JBQWdCO0FBQ2hCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTs7QUFFQTtBQUNBO0FBQ0EsaUJBQWlCLCtCQUErQjtBQUNoRDs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx5QkFBeUI7QUFDekIscUJBQXFCO0FBQ3JCO0FBQ0E7QUFDQTtBQUNBLHlCQUF5QjtBQUN6QjtBQUNBO0FBQ0E7QUFDQTs7QUFFQSw2QkFBNkIseUJBQXlCO0FBQ3REO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUEiLCJmaWxlIjoianNfYXVkaW9fd29ya2xldC5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIgXHQvLyBUaGUgbW9kdWxlIGNhY2hlXG4gXHR2YXIgaW5zdGFsbGVkTW9kdWxlcyA9IHt9O1xuXG4gXHQvLyBUaGUgcmVxdWlyZSBmdW5jdGlvblxuIFx0ZnVuY3Rpb24gX193ZWJwYWNrX3JlcXVpcmVfXyhtb2R1bGVJZCkge1xuXG4gXHRcdC8vIENoZWNrIGlmIG1vZHVsZSBpcyBpbiBjYWNoZVxuIFx0XHRpZihpbnN0YWxsZWRNb2R1bGVzW21vZHVsZUlkXSkge1xuIFx0XHRcdHJldHVybiBpbnN0YWxsZWRNb2R1bGVzW21vZHVsZUlkXS5leHBvcnRzO1xuIFx0XHR9XG4gXHRcdC8vIENyZWF0ZSBhIG5ldyBtb2R1bGUgKGFuZCBwdXQgaXQgaW50byB0aGUgY2FjaGUpXG4gXHRcdHZhciBtb2R1bGUgPSBpbnN0YWxsZWRNb2R1bGVzW21vZHVsZUlkXSA9IHtcbiBcdFx0XHRpOiBtb2R1bGVJZCxcbiBcdFx0XHRsOiBmYWxzZSxcbiBcdFx0XHRleHBvcnRzOiB7fVxuIFx0XHR9O1xuXG4gXHRcdC8vIEV4ZWN1dGUgdGhlIG1vZHVsZSBmdW5jdGlvblxuIFx0XHRtb2R1bGVzW21vZHVsZUlkXS5jYWxsKG1vZHVsZS5leHBvcnRzLCBtb2R1bGUsIG1vZHVsZS5leHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKTtcblxuIFx0XHQvLyBGbGFnIHRoZSBtb2R1bGUgYXMgbG9hZGVkXG4gXHRcdG1vZHVsZS5sID0gdHJ1ZTtcblxuIFx0XHQvLyBSZXR1cm4gdGhlIGV4cG9ydHMgb2YgdGhlIG1vZHVsZVxuIFx0XHRyZXR1cm4gbW9kdWxlLmV4cG9ydHM7XG4gXHR9XG5cblxuIFx0Ly8gZXhwb3NlIHRoZSBtb2R1bGVzIG9iamVjdCAoX193ZWJwYWNrX21vZHVsZXNfXylcbiBcdF9fd2VicGFja19yZXF1aXJlX18ubSA9IG1vZHVsZXM7XG5cbiBcdC8vIGV4cG9zZSB0aGUgbW9kdWxlIGNhY2hlXG4gXHRfX3dlYnBhY2tfcmVxdWlyZV9fLmMgPSBpbnN0YWxsZWRNb2R1bGVzO1xuXG4gXHQvLyBkZWZpbmUgZ2V0dGVyIGZ1bmN0aW9uIGZvciBoYXJtb255IGV4cG9ydHNcbiBcdF9fd2VicGFja19yZXF1aXJlX18uZCA9IGZ1bmN0aW9uKGV4cG9ydHMsIG5hbWUsIGdldHRlcikge1xuIFx0XHRpZighX193ZWJwYWNrX3JlcXVpcmVfXy5vKGV4cG9ydHMsIG5hbWUpKSB7XG4gXHRcdFx0T2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIG5hbWUsIHsgZW51bWVyYWJsZTogdHJ1ZSwgZ2V0OiBnZXR0ZXIgfSk7XG4gXHRcdH1cbiBcdH07XG5cbiBcdC8vIGRlZmluZSBfX2VzTW9kdWxlIG9uIGV4cG9ydHNcbiBcdF9fd2VicGFja19yZXF1aXJlX18uciA9IGZ1bmN0aW9uKGV4cG9ydHMpIHtcbiBcdFx0aWYodHlwZW9mIFN5bWJvbCAhPT0gJ3VuZGVmaW5lZCcgJiYgU3ltYm9sLnRvU3RyaW5nVGFnKSB7XG4gXHRcdFx0T2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogJ01vZHVsZScgfSk7XG4gXHRcdH1cbiBcdFx0T2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgeyB2YWx1ZTogdHJ1ZSB9KTtcbiBcdH07XG5cbiBcdC8vIGNyZWF0ZSBhIGZha2UgbmFtZXNwYWNlIG9iamVjdFxuIFx0Ly8gbW9kZSAmIDE6IHZhbHVlIGlzIGEgbW9kdWxlIGlkLCByZXF1aXJlIGl0XG4gXHQvLyBtb2RlICYgMjogbWVyZ2UgYWxsIHByb3BlcnRpZXMgb2YgdmFsdWUgaW50byB0aGUgbnNcbiBcdC8vIG1vZGUgJiA0OiByZXR1cm4gdmFsdWUgd2hlbiBhbHJlYWR5IG5zIG9iamVjdFxuIFx0Ly8gbW9kZSAmIDh8MTogYmVoYXZlIGxpa2UgcmVxdWlyZVxuIFx0X193ZWJwYWNrX3JlcXVpcmVfXy50ID0gZnVuY3Rpb24odmFsdWUsIG1vZGUpIHtcbiBcdFx0aWYobW9kZSAmIDEpIHZhbHVlID0gX193ZWJwYWNrX3JlcXVpcmVfXyh2YWx1ZSk7XG4gXHRcdGlmKG1vZGUgJiA4KSByZXR1cm4gdmFsdWU7XG4gXHRcdGlmKChtb2RlICYgNCkgJiYgdHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JyAmJiB2YWx1ZSAmJiB2YWx1ZS5fX2VzTW9kdWxlKSByZXR1cm4gdmFsdWU7XG4gXHRcdHZhciBucyA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG4gXHRcdF9fd2VicGFja19yZXF1aXJlX18ucihucyk7XG4gXHRcdE9iamVjdC5kZWZpbmVQcm9wZXJ0eShucywgJ2RlZmF1bHQnLCB7IGVudW1lcmFibGU6IHRydWUsIHZhbHVlOiB2YWx1ZSB9KTtcbiBcdFx0aWYobW9kZSAmIDIgJiYgdHlwZW9mIHZhbHVlICE9ICdzdHJpbmcnKSBmb3IodmFyIGtleSBpbiB2YWx1ZSkgX193ZWJwYWNrX3JlcXVpcmVfXy5kKG5zLCBrZXksIGZ1bmN0aW9uKGtleSkgeyByZXR1cm4gdmFsdWVba2V5XTsgfS5iaW5kKG51bGwsIGtleSkpO1xuIFx0XHRyZXR1cm4gbnM7XG4gXHR9O1xuXG4gXHQvLyBnZXREZWZhdWx0RXhwb3J0IGZ1bmN0aW9uIGZvciBjb21wYXRpYmlsaXR5IHdpdGggbm9uLWhhcm1vbnkgbW9kdWxlc1xuIFx0X193ZWJwYWNrX3JlcXVpcmVfXy5uID0gZnVuY3Rpb24obW9kdWxlKSB7XG4gXHRcdHZhciBnZXR0ZXIgPSBtb2R1bGUgJiYgbW9kdWxlLl9fZXNNb2R1bGUgP1xuIFx0XHRcdGZ1bmN0aW9uIGdldERlZmF1bHQoKSB7IHJldHVybiBtb2R1bGVbJ2RlZmF1bHQnXTsgfSA6XG4gXHRcdFx0ZnVuY3Rpb24gZ2V0TW9kdWxlRXhwb3J0cygpIHsgcmV0dXJuIG1vZHVsZTsgfTtcbiBcdFx0X193ZWJwYWNrX3JlcXVpcmVfXy5kKGdldHRlciwgJ2EnLCBnZXR0ZXIpO1xuIFx0XHRyZXR1cm4gZ2V0dGVyO1xuIFx0fTtcblxuIFx0Ly8gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsXG4gXHRfX3dlYnBhY2tfcmVxdWlyZV9fLm8gPSBmdW5jdGlvbihvYmplY3QsIHByb3BlcnR5KSB7IHJldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBwcm9wZXJ0eSk7IH07XG5cbiBcdC8vIF9fd2VicGFja19wdWJsaWNfcGF0aF9fXG4gXHRfX3dlYnBhY2tfcmVxdWlyZV9fLnAgPSBcIlwiO1xuXG5cbiBcdC8vIExvYWQgZW50cnkgbW9kdWxlIGFuZCByZXR1cm4gZXhwb3J0c1xuIFx0cmV0dXJuIF9fd2VicGFja19yZXF1aXJlX18oX193ZWJwYWNrX3JlcXVpcmVfXy5zID0gXCIuL3NyYy93b3JrbGV0L2pzX2F1ZGlvX3dvcmtsZXQuanNcIik7XG4iLCIvKlxuYXV0aG9yOiBIZi5QbGF0Zm9ybS5TZXRoLldhbmdcbkRhdGU6IEp1bHksMjAxN1xuXG4qL1xuZnVuY3Rpb24gUXVldWUoKSB7XG4gICAgdGhpcy5hID0gW107XG4gICAgdGhpcy5iID0gMDtcbiAgICB0aGlzLnJlc2lkdWUgPSBudWxsO1xuICAgIC8vICB0aGlzLmtleSA9IGtleTtcbn07XG5RdWV1ZS5wcm90b3R5cGUuZ2V0TGVuZ3RoID0gZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuYS5sZW5ndGggLSB0aGlzLmJcbn07XG5RdWV1ZS5wcm90b3R5cGUuaXNFbXB0eSA9IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiAwID09IHRoaXMuYS5sZW5ndGhcbn07XG5RdWV1ZS5wcm90b3R5cGUuZW5xdWV1ZSA9IGZ1bmN0aW9uKGRhdGEpIHtcbiAgICB0aGlzLmEucHVzaChkYXRhKVxufTtcblF1ZXVlLnByb3RvdHlwZS5kZXF1ZXVlID0gZnVuY3Rpb24oKSB7XG4gICAgaWYgKDAgIT0gdGhpcy5hLmxlbmd0aCkge1xuICAgICAgICB2YXIgYyA9IHRoaXMuYVt0aGlzLmJdO1xuICAgICAgICAyICogKyt0aGlzLmIgPj0gdGhpcy5hLmxlbmd0aCAmJiAodGhpcy5hID0gdGhpcy5hLnNsaWNlKHRoaXMuYiksIHRoaXMuYiA9IDApO1xuICAgICAgICByZXR1cm4gY1xuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbn07XG5RdWV1ZS5wcm90b3R5cGUucGVlayA9IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiAwIDwgdGhpcy5hLmxlbmd0aCA/IHRoaXMuYVt0aGlzLmJdIDogdm9pZCAwXG59XG5cbmZ1bmN0aW9uIEF1ZGlvUXVldWVNR1IoKSB7XG5cbiAgICB0aGlzLnNzcmNRdWV1ZU1hcCA9IG5ldyBNYXAoKTtcbiAgICBBdWRpb1F1ZXVlTUdSLnByb3RvdHlwZS5BZGRRdWV1ZSA9IGZ1bmN0aW9uKGtleSkge1xuICAgICAgICB2YXIgcXVldWUgPSBuZXcgUXVldWUoKTtcbiAgICAgICAgdGhpcy5zc3JjUXVldWVNYXAuc2V0KGtleSwgcXVldWUpO1xuICAgICAgICByZXR1cm4gcXVldWU7XG4gICAgfVxuICAgIEF1ZGlvUXVldWVNR1IucHJvdG90eXBlLkRlbGV0ZVF1ZXVlID0gZnVuY3Rpb24oa2V5KSB7XG4gICAgICAgIHRoaXMuc3NyY1F1ZXVlTWFwLmRlbGV0ZShrZXkpO1xuICAgIH1cbiAgICBBdWRpb1F1ZXVlTUdSLnByb3RvdHlwZS5HZXRRdWV1ZSA9IGZ1bmN0aW9uKGtleSkge1xuICAgICAgICB2YXIgcXVldWVfID0gdGhpcy5zc3JjUXVldWVNYXAuZ2V0KGtleSk7XG4gICAgICAgIHJldHVybiBxdWV1ZV87XG4gICAgfVxuICAgIEF1ZGlvUXVldWVNR1IucHJvdG90eXBlLkdldFF1ZXVlRGF0YSA9IGZ1bmN0aW9uKGtleSkge1xuICAgICAgICB2YXIgcXVldWVfID0gdGhpcy5zc3JjUXVldWVNYXAuZ2V0KGtleSk7XG4gICAgICAgIHJldHVybiBxdWV1ZV8uZGVxdWV1ZSgpO1xuICAgIH1cbiAgICBBdWRpb1F1ZXVlTUdSLnByb3RvdHlwZS5QdXRRdWV1ZURhdGEgPSBmdW5jdGlvbihrZXksIGRhdGEpIHtcbiAgICAgICAgdmFyIHF1ZXVlXyA9IHRoaXMuc3NyY1F1ZXVlTWFwLmdldChrZXkpO1xuICAgICAgICBxdWV1ZV8uZW5xdWV1ZShkYXRhKVxuICAgIH1cbiAgICBBdWRpb1F1ZXVlTUdSLnByb3RvdHlwZS5HZXRRdWV1ZUxlbmd0aCA9IGZ1bmN0aW9uKGtleSkge1xuICAgICAgICB2YXIgcXVldWVfID0gdGhpcy5zc3JjUXVldWVNYXAuZ2V0KGtleSk7XG4gICAgICAgIGlmIChxdWV1ZV8gIT09IG51bGwpIHtcbiAgICAgICAgICAgIHJldHVybiBxdWV1ZV8uZ2V0TGVuZ3RoKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIDA7XG4gICAgfVxuXG59O1xuXG52YXIgQXVkaW9NR1IgPSAoZnVuY3Rpb24oKSB7XG4gICAgZnVuY3Rpb24gQXVkaW9NR1IoKSB7XG4gICAgICAgIHRoaXMubWFwID0gbmV3IE1hcCgpO1xuICAgICAgICB0aGlzLkF1ZGlvUXVldWVNR1IgPSBuZXcgQXVkaW9RdWV1ZU1HUigpO1xuICAgICAgICB0aGlzLnRpbWVtYXAgPSBuZXcgTWFwKCk7XG4gICAgfTtcbiAgICBBdWRpb01HUi5wcm90b3R5cGUuQWRkID0gZnVuY3Rpb24oc3NyYywgYXVkaW9fd2Vid29yaykge1xuICAgICAgICB0aGlzLm1hcC5wdXQoc3NyYywgYXVkaW9fd2Vid29yayk7XG4gICAgICAgIHRoaXMuQXVkaW9RdWV1ZU1HUi5BZGRRdWV1ZShzc3JjKTtcbiAgICB9XG4gICAgQXVkaW9NR1IucHJvdG90eXBlLkNsZWFyID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIHRoaXMubWFwLmNsZWFyKCk7XG4gICAgfVxuICAgIEF1ZGlvTUdSLnByb3RvdHlwZS5LZXlzID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm1hcC5rZXlzKCk7XG4gICAgfVxuICAgIEF1ZGlvTUdSLnByb3RvdHlwZS5VcGRhdGVTU1JDVGltZU1hcCA9IGZ1bmN0aW9uKHRpbWVzdGFtcCkge1xuICAgICAgICB0aGlzLnRpbWVtYXAgPSB0aW1lc3RhbXA7XG4gICAgfVxuICAgIEF1ZGlvTUdSLnByb3RvdHlwZS5HZXRTU1JDVGltZU1hcCA9IGZ1bmN0aW9uKHNzcmMpIHtcbiAgICAgICAgaWYgKHRoaXMudGltZW1hcCkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMudGltZW1hcC5nZXQoc3NyYyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG5cbiAgICB9XG4gICAgcmV0dXJuIEF1ZGlvTUdSO1xufSkoKTtcblxuZnVuY3Rpb24gR2V0X0RlY29kZWRfQXVkaW9fQnVmZmVyX0xlbmd0aChzc3JjKSB7XG4gICAgc3NyYyA9IDA7XG4gICAgaWYgKGxvY2FsQXVkaW9EZWNNR1IpIHtcbiAgICAgICAgcmV0dXJuIGxvY2FsQXVkaW9EZWNNR1IuQXVkaW9RdWV1ZU1HUi5HZXRRdWV1ZUxlbmd0aChzc3JjKTtcbiAgICB9XG4gICAgcmV0dXJuIDA7XG59XG4vLyB2YXIgQXVkaW9fQnVmZmVyID0gbmV3IFF1ZXVlKCk7XG4vLyB2YXIgcmVzaWR1ZSA9IG51bGw7XG52YXIgc3RhcnRfcGxheSA9IGZhbHNlO1xudmFyIGxvY2FsQXVkaW9EZWNNR1IgPSBuZXcgQXVkaW9NR1IoKTtcbnZhciBhdWRpb0J1ZmZlclNpemUgPSAxMDtcbnZhciBzdGFydF9jYXB0dXJlID0gZmFsc2U7XG52YXIgY3VycmVudF9zc3JjID0gbnVsbDtcbnZhciBhdWRpb19jb3VudCA9IDA7XG52YXIgQVVESU9fVVBEQVRFX1NTUkNfVElNRV9JTlRFUlZBTCA9IDIzO1xudmFyIExPR19QUklOVF9JTlRFUlZBTCA9IDEwMDAwO1xudmFyIGxvZ19jb3VudCA9IDA7XG52YXIgcG9zdF9jYXB0dXJlX2F1ZGlvX2NvdW50ID0gMDtcbnZhciBBVURJT19DQVBUVVJFX01BWF9DT1VOVCA9IDA7XG52YXIgY2FwdHVyZV9hdWRpb19idWZmZXIgPSBudWxsO1xudmFyIGF1ZGlvRW5jb2RlUG9ydDtcbnZhciBhdWRpb0RlY29kZVBvcnQ7XG52YXIgYXVkaW9EZWNvZGVQb3J0V2l0aFZpZGVvID0gbnVsbDtcbnZhciBzc3JjTnRwTWFwID0gbmV3IE1hcCgpO1xudmFyIHJlc2lkdWVPZmZzZXQgPSAwO1xuZnVuY3Rpb24gUHV0X0F1ZGlvX0ZyYW1lX0J1ZmZlcihzc3JjLCBidWZmZXIsIHRpbWVfc3RhbXAsIHRoYXQpIHtcbiAgICBzc3JjID0gMDtcbiAgICBpZiAoIXN0YXJ0X3BsYXkpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAobG9jYWxBdWRpb0RlY01HUikge1xuICAgICAgICB2YXIgc3NyY3F1ZXVlXyA9IGxvY2FsQXVkaW9EZWNNR1IuQXVkaW9RdWV1ZU1HUi5HZXRRdWV1ZShzc3JjKTsgLy8gbmVlZCBzcGVjaWFsIHNzcmMsIGFzIGF1ZGlvIGhhZCBiZWVuIE1peGVkLlxuICAgICAgICBpZiAoIXNzcmNxdWV1ZV8pIHtcbiAgICAgICAgICAgIHNzcmNxdWV1ZV8gPSBsb2NhbEF1ZGlvRGVjTUdSLkF1ZGlvUXVldWVNR1IuQWRkUXVldWUoc3NyYyk7XG4gICAgICAgIH1cbiAgICAgICAgLy8gYnVmZmVyID0gVWludDhUb0Zsb2F0MzIoYnVmZmVyKTtcbiAgICAgICAgaWYgKHRpbWVfc3RhbXApIHtcbiAgICAgICAgICAgIC8vIHZhciB0aW1lbWFwID0gbmV3IE1hcCgpO1xuICAgICAgICAgICAgdmFyIG51bWJlck9mU1NSQyA9IHRpbWVfc3RhbXAubGVuZ3RoIC8gMTI7XG4gICAgICAgICAgICB2YXIgaW5kZXggPSAwO1xuICAgICAgICAgICAgdmFyIGkgPSAwO1xuICAgICAgICAgICAgZm9yIChpbmRleCA9IDA7IGluZGV4IDwgbnVtYmVyT2ZTU1JDOyBpbmRleCsrKSB7XG4gICAgICAgICAgICAgICAgdmFyIHNzcmMgPSAwO1xuICAgICAgICAgICAgICAgIGZvciAoaSA9IGluZGV4ICogMTIgKyAwOyBpIDwgaW5kZXggKiAxMiArIDQ7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBzc3JjICs9IHRpbWVfc3RhbXBbaV0gKiBNYXRoLnBvdygyNTYsIChpIC0gaW5kZXggKiAxMikpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBzc3JjID0gc3NyYyA+PiAxMDtcbiAgICAgICAgICAgICAgICB2YXIgdHMgPSAwO1xuICAgICAgICAgICAgICAgIGZvciAoaSA9IGluZGV4ICogMTIgKyA0OyBpIDwgaW5kZXggKiAxMiArIDEyOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgdHMgKz0gdGltZV9zdGFtcFtpXSAqIE1hdGgucG93KDI1NiwgKGkgLSBpbmRleCAqIDEyIC0gNCkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBzc3JjTnRwTWFwLnNldChzc3JjLCB0cyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgbWVzc2FnZSA9IGJ1ZmZlcjtcbiAgICAgICAgICAgIFNlbmRfQnVmZmVyX0JhY2tfVE9fRGVjb2RlX1dvcmtlcih0aW1lX3N0YW1wKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSBidWZmZXI7XG4gICAgICAgIH1cblxuICAgICAgICBzc3JjcXVldWVfLmVucXVldWUobWVzc2FnZSk7XG4gICAgICAgIHZhciBhdWRpb3F1ZXVlbGVuZ3RoID0gR2V0X0RlY29kZWRfQXVkaW9fQnVmZmVyX0xlbmd0aChzc3JjKTtcbiAgICAgICAgLy8gY29uc29sZS5sb2coXCJhdWRpbyBxdWV1ZSBsZW5ndGg6IFwiK2F1ZGlvcXVldWVsZW5ndGgpXG4gICAgICAgIGlmIChhdWRpb3F1ZXVlbGVuZ3RoID4gNykge1xuICAgICAgICAgICAgaWYgKGF1ZGlvRGVjb2RlUG9ydClcbiAgICAgICAgICAgICAgICBhdWRpb0RlY29kZVBvcnQucG9zdE1lc3NhZ2Uoe1xuICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IFwiZGVsYXlcIixcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIGlmIChhdWRpb3F1ZXVlbGVuZ3RoID4gNTApIHtcbiAgICAgICAgICAgIHZhciBkaWZmID0gYXVkaW9xdWV1ZWxlbmd0aCAtIGF1ZGlvQnVmZmVyU2l6ZTtcbiAgICAgICAgICAgIHdoaWxlIChkaWZmID49IDApIHtcbiAgICAgICAgICAgICAgICBEZWxldGVfRGVjb2RlZF9BdWRpb19GcmFtZShzc3JjKTtcbiAgICAgICAgICAgICAgICBkaWZmLS07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmZ1bmN0aW9uIERlbGV0ZV9EZWNvZGVkX0F1ZGlvX0ZyYW1lKHNzcmMpIHtcbiAgICBzc3JjID0gMDtcbiAgICBpZiAoIWxvY2FsQXVkaW9EZWNNR1IpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB2YXIgc3NyY19xdWV1ZV8gPSBsb2NhbEF1ZGlvRGVjTUdSLkF1ZGlvUXVldWVNR1IuR2V0UXVldWUoc3NyYylcbiAgICBpZiAoc3NyY19xdWV1ZV8pIHtcbiAgICAgICAgdmFyIGRhdGFfbm9kZSA9IHNzcmNfcXVldWVfLmRlcXVldWUoKTtcbiAgICAgICAgU2VuZF9CdWZmZXJfQmFja19UT19EZWNvZGVfV29ya2VyKGRhdGFfbm9kZSk7XG4gICAgICAgIHJldHVybiBkYXRhX25vZGU7XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xufVxuXG5mdW5jdGlvbiBHZXRfU1NSQ19MYXRlc3RfVGltZShlKSB7XG4gICAgZSA9IGUgPj4gMTA7XG4gICAgaWYgKGxvY2FsQXVkaW9EZWNNR1IpIHtcbiAgICAgICAgdmFyIHQgPSBzc3JjTnRwTWFwLmdldChlKTtcbiAgICAgICAgaWYgKCF0KSB7XG4gICAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHNzcmNOdHBNYXAuc2V0KGUsIDApO1xuICAgICAgICAgICAgcmV0dXJuIHQ7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmZ1bmN0aW9uIFNlbmRfQnVmZmVyX0JhY2tfVE9fRGVjb2RlX1dvcmtlcihidWZmKSB7XG4gICAgaWYgKGF1ZGlvRGVjb2RlUG9ydCkge1xuICAgICAgICB2YXIgZGF0YSA9IHtcbiAgICAgICAgICAgIHN0YXR1czogXCJ0cmFzaFwiLFxuICAgICAgICAgICAgZGF0YTogYnVmZlxuICAgICAgICB9O1xuICAgICAgICBhdWRpb0RlY29kZVBvcnQucG9zdE1lc3NhZ2UoZGF0YSwgW2RhdGEuZGF0YS5idWZmZXJdKTtcbiAgICB9XG59XG5mdW5jdGlvbiBHZXRfRGVjb2RlZF9BdWRpb19GcmFtZShzc3JjLCB0aW1lX3N0YW1wLCBBdWRpb19Ob2RlX0J1ZmZlcl9TaXplLCBvdXRwdXQpIHtcbiAgICBpZiAoIWxvY2FsQXVkaW9EZWNNR1IpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBzc3JjID0gMDtcbiAgICB2YXIgc3NyY19xdWV1ZSA9IGxvY2FsQXVkaW9EZWNNR1IuQXVkaW9RdWV1ZU1HUi5HZXRRdWV1ZShzc3JjKTtcbiAgICB2YXIgYXVkaW9fZGF0YSA9IG51bGw7XG4gICAgaWYgKHNzcmNfcXVldWUpIHtcbiAgICAgICAgaWYgKHNzcmNfcXVldWUucmVzaWR1ZSkge1xuICAgICAgICAgICAgbGV0IHJlYWxMZWZ0ID0gc3NyY19xdWV1ZS5yZXNpZHVlLmxlbmd0aCAtIHJlc2lkdWVPZmZzZXQ7XG4gICAgICAgICAgICBpZiAocmVhbExlZnQgPiBBdWRpb19Ob2RlX0J1ZmZlcl9TaXplKSB7XG4gICAgICAgICAgICAgICAgLy8gbGV0IGxvY2FsX3Jlc2lkdWVfbGVuZ3RoID0gc3NyY19xdWV1ZS5yZXNpZHVlLmJ1ZmZlci5sZW5ndGg7XG4gICAgICAgICAgICAgICAgLy8gYXVkaW9fZGF0YSA9IHNzcmNfcXVldWUucmVzaWR1ZS5idWZmZXIuc2xpY2UoMCwgQXVkaW9fTm9kZV9CdWZmZXJfU2l6ZSk7XG4gICAgICAgICAgICAgICAgLy8gc3NyY19xdWV1ZS5yZXNpZHVlLmJ1ZmZlciA9IHNzcmNfcXVldWUucmVzaWR1ZS5idWZmZXIuc2xpY2UoQXVkaW9fTm9kZV9CdWZmZXJfU2l6ZSlcbiAgICAgICAgICAgICAgICBvdXRwdXQuc2V0KHNzcmNfcXVldWUucmVzaWR1ZS5zdWJhcnJheShyZXNpZHVlT2Zmc2V0LCAocmVzaWR1ZU9mZnNldCArIEF1ZGlvX05vZGVfQnVmZmVyX1NpemUpKSwgKG91dHB1dC5sZW5ndGggLSBBdWRpb19Ob2RlX0J1ZmZlcl9TaXplKSk7XG4gICAgICAgICAgICAgICAgcmVzaWR1ZU9mZnNldCA9IHJlc2lkdWVPZmZzZXQgKyBBdWRpb19Ob2RlX0J1ZmZlcl9TaXplO1xuICAgICAgICAgICAgICAgIC8vIFVwZGF0ZV9BdWRpb19TU1JDX1RpbWUoc3NyY19xdWV1ZS5yZXNpZHVlLm50cHRpbWUpO1xuICAgICAgICAgICAgICAgIHJldHVybiA7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHJlYWxMZWZ0ID09PSBBdWRpb19Ob2RlX0J1ZmZlcl9TaXplKSB7XG4gICAgICAgICAgICAgICAgLy8gYXVkaW9fZGF0YSA9IHNzcmNfcXVldWUucmVzaWR1ZS5idWZmZXI7XG4gICAgICAgICAgICAgICAgLy8gVXBkYXRlX0F1ZGlvX1NTUkNfVGltZShzc3JjX3F1ZXVlLnJlc2lkdWUubnRwdGltZSk7XG4gICAgICAgICAgICAgICAgb3V0cHV0LnNldChzc3JjX3F1ZXVlLnJlc2lkdWUuc3ViYXJyYXkocmVzaWR1ZU9mZnNldCwgKHJlc2lkdWVPZmZzZXQgKyBBdWRpb19Ob2RlX0J1ZmZlcl9TaXplKSksIChvdXRwdXQubGVuZ3RoIC0gQXVkaW9fTm9kZV9CdWZmZXJfU2l6ZSkpO1xuICAgICAgICAgICAgICAgIFNlbmRfQnVmZmVyX0JhY2tfVE9fRGVjb2RlX1dvcmtlcihzc3JjX3F1ZXVlLnJlc2lkdWUpO1xuICAgICAgICAgICAgICAgIHNzcmNfcXVldWUucmVzaWR1ZSA9IG51bGw7XG4gICAgICAgICAgICAgICAgcmVzaWR1ZU9mZnNldCA9IDA7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBhdWRpb19kYXRhID0gc3NyY19xdWV1ZS5yZXNpZHVlO1xuICAgICAgICAgICAgICAgIC8vIFVwZGF0ZV9BdWRpb19TU1JDX1RpbWUoc3NyY19xdWV1ZS5yZXNpZHVlLm50cHRpbWUpO1xuICAgICAgICAgICAgICAgIG91dHB1dC5zZXQoc3NyY19xdWV1ZS5yZXNpZHVlLnN1YmFycmF5KHJlc2lkdWVPZmZzZXQsIGF1ZGlvX2RhdGEubGVuZ3RoKSwgKG91dHB1dC5sZW5ndGggLSBBdWRpb19Ob2RlX0J1ZmZlcl9TaXplKSk7XG4gICAgICAgICAgICAgICAgLy8gb25lQXVkaW9GcmFtZS5zZXQoc3NyY19xdWV1ZS5yZXNpZHVlLmJ1ZmZlciwgcmVzaWR1ZU9mZnNldCwgYXVkaW9fZGF0YS5sZW5ndGgpO1xuICAgICAgICAgICAgICAgIFNlbmRfQnVmZmVyX0JhY2tfVE9fRGVjb2RlX1dvcmtlcihzc3JjX3F1ZXVlLnJlc2lkdWUpO1xuICAgICAgICAgICAgICAgIHNzcmNfcXVldWUucmVzaWR1ZSA9IG51bGw7XG4gICAgICAgICAgICAgICAgcmVzaWR1ZU9mZnNldCA9IDA7XG4gICAgICAgICAgICAgICAgQXVkaW9fTm9kZV9CdWZmZXJfU2l6ZSA9IEF1ZGlvX05vZGVfQnVmZmVyX1NpemUgLSByZWFsTGVmdDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHZhciBkYXRhX25vZGUgPSBzc3JjX3F1ZXVlLmRlcXVldWUoKTtcbiAgICAgICAgd2hpbGUgKGRhdGFfbm9kZSAmJiBkYXRhX25vZGUubGVuZ3RoIDwgQXVkaW9fTm9kZV9CdWZmZXJfU2l6ZSkge1xuICAgICAgICAgICAgLy8gVXBkYXRlX0F1ZGlvX1NTUkNfVGltZShkYXRhX25vZGUubnRwdGltZSk7XG4gICAgICAgICAgICAvLyBhdWRpb19kYXRhID0gRmxvYXQzMkNvbmNhdChhdWRpb19kYXRhLCBkYXRhX25vZGUuYnVmZmVyKTtcbiAgICAgICAgICAgIG91dHB1dC5zZXQoZGF0YV9ub2RlLCBvdXRwdXQubGVuZ3RoIC0gQXVkaW9fTm9kZV9CdWZmZXJfU2l6ZSk7XG4gICAgICAgICAgICBTZW5kX0J1ZmZlcl9CYWNrX1RPX0RlY29kZV9Xb3JrZXIoZGF0YV9ub2RlKTtcbiAgICAgICAgICAgIEF1ZGlvX05vZGVfQnVmZmVyX1NpemUgPSBBdWRpb19Ob2RlX0J1ZmZlcl9TaXplIC0gZGF0YV9ub2RlLmxlbmd0aFxuICAgICAgICAgICAgZGF0YV9ub2RlID0gc3NyY19xdWV1ZS5kZXF1ZXVlKCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZGF0YV9ub2RlKSB7XG4gICAgICAgICAgICAvLyBVcGRhdGVfQXVkaW9fU1NSQ19UaW1lKGRhdGFfbm9kZS5udHB0aW1lKTtcbiAgICAgICAgICAgIGlmIChkYXRhX25vZGUubGVuZ3RoID09PSBBdWRpb19Ob2RlX0J1ZmZlcl9TaXplKSB7XG4gICAgICAgICAgICAgICAgLy8gYXVkaW9fZGF0YSA9IEZsb2F0MzJDb25jYXQoYXVkaW9fZGF0YSwgZGF0YV9ub2RlLmJ1ZmZlcik7XG4gICAgICAgICAgICAgICAgb3V0cHV0LnNldChkYXRhX25vZGUsIG91dHB1dC5sZW5ndGggLSBBdWRpb19Ob2RlX0J1ZmZlcl9TaXplKTtcbiAgICAgICAgICAgICAgICByZXNpZHVlT2Zmc2V0ID0gMDtcbiAgICAgICAgICAgICAgICBTZW5kX0J1ZmZlcl9CYWNrX1RPX0RlY29kZV9Xb3JrZXIoZGF0YV9ub2RlKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGRhdGFfbm9kZS5sZW5ndGggPiBBdWRpb19Ob2RlX0J1ZmZlcl9TaXplKSB7XG4gICAgICAgICAgICAgICAgLy8gYXVkaW9fZGF0YSA9IEZsb2F0MzJDb25jYXQoYXVkaW9fZGF0YSwgZGF0YV9ub2RlLmJ1ZmZlci5zbGljZSgwLCBBdWRpb19Ob2RlX0J1ZmZlcl9TaXplKSk7XG4gICAgICAgICAgICAgICAgb3V0cHV0LnNldChkYXRhX25vZGUuc3ViYXJyYXkoMCxBdWRpb19Ob2RlX0J1ZmZlcl9TaXplKSwgb3V0cHV0Lmxlbmd0aCAtIEF1ZGlvX05vZGVfQnVmZmVyX1NpemUpXG4gICAgICAgICAgICAgICAgc3NyY19xdWV1ZS5yZXNpZHVlID0gZGF0YV9ub2RlO1xuICAgICAgICAgICAgICAgIHJlc2lkdWVPZmZzZXQgPSBBdWRpb19Ob2RlX0J1ZmZlcl9TaXplO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKFwicXVldWUgaXMgZW1wdHlcIilcbiAgICAgICAgfVxuICAgICAgICAvLyBpZiAoYXVkaW9fZGF0YSkge1xuICAgICAgICAvLyAgICAgaWYgKGF1ZGlvX2RhdGEubGVuZ3RoIDwgYXVkaW9fbGVuZ3RoKSB7XG4gICAgICAgIC8vICAgICAgICAgc3NyY19xdWV1ZS5yZXNpZHVlID0ge1xuICAgICAgICAvLyAgICAgICAgICAgICBidWZmZXI6IGF1ZGlvX2RhdGEsXG4gICAgICAgIC8vICAgICAgICAgICAgIG50cHRpbWU6IG51bGxcbiAgICAgICAgLy8gICAgICAgICB9XG4gICAgICAgIC8vICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIC8vICAgICB9IGVsc2UgaWYgKGF1ZGlvX2RhdGEubGVuZ3RoID09IGF1ZGlvX2xlbmd0aCkge1xuICAgICAgICAvLyAgICAgICAgIHJldHVybiBhdWRpb19kYXRhO1xuICAgICAgICAvLyAgICAgfVxuICAgICAgICAvLyB9XG4gICAgfVxuICAgIHJldHVybjtcbn1cblxuY2xhc3MgWm9vbUF1ZGlvV29ybGV0UHJvY2Vzc29yIGV4dGVuZHMgQXVkaW9Xb3JrbGV0UHJvY2Vzc29yIHtcblxuICAgIC8vIEN1c3RvbSBBdWRpb1BhcmFtcyBjYW4gYmUgZGVmaW5lZCB3aXRoIHRoaXMgc3RhdGljIGdldHRlci5cbiAgICBzdGF0aWMgZ2V0IHBhcmFtZXRlckRlc2NyaXB0b3JzKCkge1xuICAgICAgICByZXR1cm4gW3sgbmFtZTogJ3BjbScsIGRlZmF1bHRWYWx1ZTogMSB9XTtcbiAgICB9XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgLy8gVGhlIHN1cGVyIGNvbnN0cnVjdG9yIGNhbGwgaXMgcmVxdWlyZWQuXG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMucG9ydC5vbm1lc3NhZ2UgPSB0aGlzLmhhbmRsZU1lc3NhZ2UuYmluZCh0aGlzKTtcbiAgICAgICAgdGhpcy5zYW1wbGVSYXRlXyA9IDA7XG4gICAgICAgIHRoaXMudGVuTWlsbGlTZWNvbmRzTGVuZ3RoXyA9IDA7XG4gICAgfVxuXG4gICAgaGFuZGxlTWVzc2FnZShldmVudCkge1xuICAgICAgICAvLyBjb25zb2xlLmxvZygnW1Byb2Nlc3NvcjpSZWNlaXZlZF0gXCInICsgZXZlbnQuZGF0YS5tZXNzYWdlICtcbiAgICAgICAgLy8gICAgICdcIiAoJyArIGV2ZW50LmRhdGEudGltZVN0YW1wICsgJyknKTtcbiAgICAgICAgdmFyIGRhdGEgPSBldmVudC5kYXRhO1xuICAgICAgICBzd2l0Y2ggKGRhdGEuc3RhdHVzKSB7XG4gICAgICAgICAgICBjYXNlIFwiZGF0YVwiOlxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGlmIChzdGFydF9wbGF5KSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIEF1ZGlvX0J1ZmZlci5lbnF1ZXVlKFVpbnQ4VG9GbG9hdDMyKGRhdGEuZGF0YSkpO1xuICAgICAgICAgICAgICAgICAgICBQdXRfQXVkaW9fRnJhbWVfQnVmZmVyKGRhdGEuZGF0YS5zc3JjLCBkYXRhLmRhdGEuZGF0YSwgZGF0YS5kYXRhLnRpbWUsIHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICBjdXJyZW50X3NzcmMgPSBkYXRhLmRhdGEuc3NyYztcbiAgICAgICAgICAgICAgICAgICAgLy8gaWYoIWN1cnJlbnRfc3NyYyl7XG4gICAgICAgICAgICAgICAgICAgIC8vICAgICBjdXJyZW50X3NzcmMgPSBkYXRhLmRhdGEuc3NyYztcbiAgICAgICAgICAgICAgICAgICAgLy8gfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgXCJzdG9wUGxheUF1ZGlvXCI6XG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgc3RhcnRfcGxheSA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBcInN0YXJ0UGxheUF1ZGlvXCI6XG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgc3RhcnRfcGxheSA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIFwiY2xvc2VcIjpcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAvLyBjbG9zZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBcIlN0YXJ0Q2FwdHVyZUF1ZGlvXCI6XG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgc3RhcnRfY2FwdHVyZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgcG9zdF9jYXB0dXJlX2F1ZGlvX2NvdW50ID0gMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgXCJDdXJyZW50U1NSQ1wiOlxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGN1cnJlbnRfc3NyYyA9IGRhdGEuZGF0YTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgXCJlbmNvZGVBdWRpb1BvcnRcIjpcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBpZihhdWRpb0VuY29kZVBvcnQpe1xuICAgICAgICAgICAgICAgICAgICBhdWRpb0VuY29kZVBvcnQuY2xvc2UoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYXVkaW9FbmNvZGVQb3J0ID0gZXZlbnQucG9ydHNbMF07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIFwiZGVjb2RlQXVkaW9Qb3J0XCI6IHtcbiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7XG4gICAgICAgICAgICAgICAgaWYgKGF1ZGlvRGVjb2RlUG9ydCkge1xuICAgICAgICAgICAgICAgICAgICBhdWRpb0RlY29kZVBvcnQuY2xvc2UoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYXVkaW9EZWNvZGVQb3J0ID0gZXZlbnQucG9ydHNbMF07XG4gICAgICAgICAgICAgICAgYXVkaW9EZWNvZGVQb3J0Lm9ubWVzc2FnZSA9IGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGFydF9wbGF5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBBdWRpb19CdWZmZXIuZW5xdWV1ZShVaW50OFRvRmxvYXQzMihkYXRhLmRhdGEpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIFB1dF9BdWRpb19GcmFtZV9CdWZmZXIoZS5kYXRhLnNzcmMsIGUuZGF0YS5kYXRhLCBlLmRhdGEudGltZSwgdGhhdCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50X3NzcmMgPSBlLmRhdGEuc3NyYztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhcnRfY2FwdHVyZSYmZmFsc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkYXRhID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbW1hbmQ6IFwiRWNob0NhbmNlbFwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IGUuZGF0YS5hZWMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhbm5lbHM6IGUuZGF0YS5jaGFubmVscyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYW1wbGVIejogZS5kYXRhLnNhbXBsZUh6XG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgYXVkaW9FbmNvZGVQb3J0LnBvc3RNZXNzYWdlKGRhdGEsIFtkYXRhLmRhdGEuYnVmZmVyXSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIFwiZGVjb2RlQXVkaW9Qb3J0V2l0aFZpZGVvXCI6IHtcbiAgICAgICAgICAgICAgICBhdWRpb0RlY29kZVBvcnRXaXRoVmlkZW8gPSBldmVudC5wb3J0c1swXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgXCJzYW1wbGVSYXRlXCI6IHtcbiAgICAgICAgICAgICAgICB0aGlzLnNhbXBsZVJhdGVfID0gZGF0YS5kYXRhO1xuICAgICAgICAgICAgICAgIC8vdGhpcy5zYW1wbGVSYXRlIC8xMDAgPT0gMTBtc1xuICAgICAgICAgICAgICAgIC8vODAwMGh6IGlzIGJhc2UgbGluZSBmb3IgYXVkaW8gYXBwLlxuICAgICAgICAgICAgICAgIGlmICh0aGlzLnNhbXBsZVJhdGVfID49IDgwMDApIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZW5NaWxsaVNlY29uZHNMZW5ndGhfID0gdGhpcy5zYW1wbGVSYXRlXyAvIDEwMDtcbiAgICAgICAgICAgICAgICAgICAgLy90aGUgbWF4aW11bSBidWZmZXIgZGVsYXkgc2V0IHRvIGJlIDMwbXMuXG4gICAgICAgICAgICAgICAgICAgIEFVRElPX0NBUFRVUkVfTUFYX0NPVU5UID0gTWF0aC5jZWlsKCgodGhpcy50ZW5NaWxsaVNlY29uZHNMZW5ndGhfKSAqIDMpIC8gMTI4KTtcbiAgICAgICAgICAgICAgICAgICAgY2FwdHVyZV9hdWRpb19idWZmZXIgPSBuZXcgRmxvYXQzMkFycmF5KDEyOCAqIEFVRElPX0NBUFRVUkVfTUFYX0NPVU5UKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcm9jZXNzKGlucHV0cywgb3V0cHV0cywgcGFyYW1ldGVycykge1xuICAgICAgICBsZXQgaW5wdXQgPSBpbnB1dHNbMF07XG4gICAgICAgIGxldCBvdXRwdXQgPSBvdXRwdXRzWzBdO1xuXG4gICAgICAgIGlmICghdGhpcy5zYW1wbGVSYXRlXyB8fCAhb3V0cHV0WzBdKSB7XG4gICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgR2V0X0RlY29kZWRfQXVkaW9fRnJhbWUoMCwgMCwgb3V0cHV0WzBdLmxlbmd0aCwgb3V0cHV0WzBdKVxuXG4gICAgICAgIGlmIChpbnB1dFswXSAmJiBzdGFydF9jYXB0dXJlKSB7XG4gICAgICAgICAgICBjYXB0dXJlX2F1ZGlvX2J1ZmZlci5zZXQoaW5wdXRbMF0scG9zdF9jYXB0dXJlX2F1ZGlvX2NvdW50ICogMTI4KTtcbiAgICAgICAgICAgIHBvc3RfY2FwdHVyZV9hdWRpb19jb3VudCsrO1xuICAgICAgICAgICAgaWYocG9zdF9jYXB0dXJlX2F1ZGlvX2NvdW50ID09IEFVRElPX0NBUFRVUkVfTUFYX0NPVU5UKXtcbiAgICAgICAgICAgICAgICBwb3N0X2NhcHR1cmVfYXVkaW9fY291bnQgPSAwO1xuICAgICAgICAgICAgICAgIGF1ZGlvRW5jb2RlUG9ydC5wb3N0TWVzc2FnZSh7XG4gICAgICAgICAgICAgICAgICAgIGNvbW1hbmQ6XCJFbmNvZGVBdWRpb0ZyYW1lXCIsXG4gICAgICAgICAgICAgICAgICAgIGRhdGE6Y2FwdHVyZV9hdWRpb19idWZmZXJcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYoY3VycmVudF9zc3JjKXtcbiAgICAgICAgICAgIGF1ZGlvX2NvdW50Kys7XG4gICAgICAgICAgICBpZiAoYXVkaW9fY291bnQgPT0gQVVESU9fVVBEQVRFX1NTUkNfVElNRV9JTlRFUlZBTCkge1xuICAgICAgICAgICAgICAgIGF1ZGlvX2NvdW50ID0gMDtcbiAgICAgICAgICAgICAgICB2YXIgdGltZSA9IEdldF9TU1JDX0xhdGVzdF9UaW1lKGN1cnJlbnRfc3NyYyk7XG4gICAgICAgICAgICAgICAgaWYodGltZSl7XG4gICAgICAgICAgICAgICAgICAgIGlmKGF1ZGlvRGVjb2RlUG9ydFdpdGhWaWRlbyl7XG4gICAgICAgICAgICAgICAgICAgICAgICBhdWRpb0RlY29kZVBvcnRXaXRoVmlkZW8ucG9zdE1lc3NhZ2Uoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IHRpbWVcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wb3J0LnBvc3RNZXNzYWdlKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IFwiSW5zdGFudEF1ZGlvVGltZVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IHRpbWVcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgZm9yIChsZXQgY2hhbm5lbCA9IDE7IGNoYW5uZWwgPCBvdXRwdXQubGVuZ3RoOyArK2NoYW5uZWwpIHtcbiAgICAgICAgICAgIGxldCBvdXRwdXRDaGFubmVsID0gb3V0cHV0W2NoYW5uZWxdO1xuICAgICAgICAgICAgb3V0cHV0Q2hhbm5lbC5zZXQob3V0cHV0WzBdKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbn1cblxucmVnaXN0ZXJQcm9jZXNzb3IoJ3pvb21BdWRpb1dvcmtsZXQnLCBab29tQXVkaW9Xb3JsZXRQcm9jZXNzb3IpO1xuIl0sInNvdXJjZVJvb3QiOiIifQ==